{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Shop Products{% endblock %}
{% block content %}
<style>
    .product-card:hover {
        transform: scale(1.05);
        transition: transform 0.3s;
    }

    .card {
        border: none;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .quantity-control input {
        width: 60px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .quantity-button {
        border-radius: 5px;
        width: 40px;
        transition: all 0.2s ease;
    }

    .quantity-button:disabled,
    .quantity-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .quantity-button:not(:disabled):hover {
        background-color: #008751;
        color: white;
        transform: translateY(-2px);
    }

    .add-to-cart-button {
        border-radius: 5px;
        width: 100%;
    }

    .modal-content {
        border-radius: 10px;
        overflow: hidden;
        background-color: #f8f9fa;
    }

    /* Quantity change animation */
    @keyframes quantityPulse {
        0% { transform: scale(1); background-color: white; }
        50% { transform: scale(1.1); background-color: rgba(0, 135, 81, 0.1); }
        100% { transform: scale(1); background-color: white; }
    }

    .quantity-changed {
        animation: quantityPulse 0.3s ease;
    }

    /* Shop Hero Section Styles */
    .shop-hero {
        background-color: #f8f9fa;
        position: relative;
        overflow: hidden;
        padding: 10px 0;
    }

    .shop-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(to right, #008751, #F7C600);
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: white;
        padding: 8px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .feature-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .feature-item i {
        color: #008751;
        font-size: 1.2rem;
    }

    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .shop-hero {
            padding: 5px 0;
        }

        .feature-item {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .feature-item i {
            font-size: 1rem;
        }

        .shop-header {
            margin-bottom: 0.5rem !important;
        }
    }

    /* Featured Products Section Styles */
    .section-title {
        font-family: 'Playfair Display', serif;
        color: #2E3A23;
        font-size: 1.8rem;
        position: relative;
        margin-bottom: 0;
    }

    .section-decoration {
        height: 3px;
        width: 100px;
        background: linear-gradient(to right, #008751, #F7C600);
        margin-left: 20px;
    }

    .featured-product-card {
        display: flex;
        flex-direction: column;
        background-color: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        transition: all 0.4s ease;
        height: 100%;
    }

    .featured-product-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 30px rgba(0,0,0,0.12);
    }

    .featured-product-image {
        position: relative;
        height: 250px;
        overflow: hidden;
    }

    .featured-product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s ease;
    }

    .featured-product-card:hover .featured-product-image img {
        transform: scale(1.1);
    }

    .featured-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: linear-gradient(45deg, #008751, #20c997);
        color: white;
        padding: 8px 16px;
        border-radius: 30px;
        font-weight: 700;
        font-size: 0.8rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .featured-product-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .featured-product-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.3rem;
        margin-bottom: 10px;
        color: #2E3A23;
    }

    .featured-product-description {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 15px;
        flex-grow: 1;
    }

    .featured-product-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: #008751;
        margin-bottom: 15px;
        padding: 5px 12px;
        background-color: rgba(0,135,81,0.1);
        border-radius: 8px;
        display: inline-block;
    }

    .btn-view-product {
        background-color: #008751;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        flex-grow: 1;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .btn-view-product:hover {
        background-color: #006b3e;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .featured-product-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn-add-to-cart {
        background-color: #F7C600;
        color: #2E3A23;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-grow: 1;
    }

    .btn-add-to-cart:hover {
        transform: translateY(-3px);
        background-color: #e6b800;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .btn-add-to-cart i {
        font-size: 1.1rem;
    }

    /* Add to cart animation */
    @keyframes addingToCart {
        0% { transform: scale(1); background-color: #F7C600; }
        50% { transform: scale(1.05); background-color: #008751; color: white; }
        100% { transform: scale(1); background-color: #F7C600; }
    }

    .adding-to-cart {
        animation: addingToCart 1s ease-in-out;
        pointer-events: none;
    }

    /* Category Highlights Styles */
    .category-highlight-card {
        height: 150px;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        background: linear-gradient(45deg, rgba(0,135,81,0.8), rgba(247,198,0,0.8));
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: all 0.4s ease;
        width: 100%;
        border: none;
        padding: 0;
        text-align: center;
    }

    .category-highlight-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.12);
    }

    .category-highlight-card:focus-visible {
        outline: 3px solid #ffffff;
        outline-offset: -3px;
    }

    .category-highlight-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        padding: 20px;
    }

    .category-highlight-content h3 {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        margin-bottom: 5px;
        text-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .category-highlight-content p {
        font-size: 0.9rem;
        margin-bottom: 15px;
        opacity: 0.9;
    }

    .category-link {
        display: inline-block;
        padding: 8px 16px;
        background-color: white;
        color: #008751;
        border-radius: 30px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .category-highlight-card:hover .category-link {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Products Section Styles */
    .products-section {
        margin-bottom: 40px;
    }

    /* Lazy loading image styles */
    img.lazyload {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    img.loaded {
        opacity: 1;
    }

    /* Search input styles */
    #search-input {
        transition: all 0.2s ease-in-out;
    }

    #search-input.searching {
        background-color: rgba(0, 135, 81, 0.05);
        border-color: #008751;
    }

    /* Improve search suggestions appearance */
    #search-suggestions {
        border: 1px solid #dee2e6;
        border-top: none;
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        border-radius: 0 0 0.25rem 0.25rem;
    }

    .suggestion-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .suggestion-item:hover {
        background-color: rgba(0, 135, 81, 0.05);
    }

    .suggestion-name {
        font-weight: 500;
        font-size: 0.9rem;
    }

    .suggestion-price {
        font-size: 0.8rem;
    }
</style>

<body>
    <!-- BREADCRUMB -->
    <nav class="py-3">
        <div class="container">
            <ol class="breadcrumb mb-0 fs-xs text-gray-400">
                <li class="breadcrumb-item">
                    <a class="text-gray-400" href="{% url 'index' %}">Home</a>
                </li>
                <li class="breadcrumb-item active">Shop</li>
            </ol>
        </div>
    </nav>

<!-- SHOP HERO SECTION -->
<section class="py-2 bg-light shop-hero">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="feature-item">
                        <i class="fas fa-shipping-fast"></i>
                        <span>Fast Shipping</span>
                    </div>
                    <div class="feature-item d-none d-md-flex">
                        <i class="fas fa-certificate"></i>
                        <span>Authentic Products</span>
                    </div>
                    <div class="feature-item d-none d-md-flex">
                        <i class="fas fa-undo"></i>
                        <span>Easy Returns</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CONTENT -->
<div class="container-fluid">
    <div class="row gx-0">

        <!-- Category Selection - Visible only on large screens -->
        <div class="col-12 col-lg-auto d-none d-lg-block">
            <nav class="navbar navbar-expand navbar-vertical navbar-light sticky-start px-lg-7">
                <div class="category-sidebar">
                    <h5 class="sidebar-heading">Categories</h5>
                    <ul class="navbar-nav fs-lg mb-6 my-lg-4 mx-sm-3" id="sidenavParent">
                        <li class="nav-item">
                            <a class="nav-link category-link active" href="#" id="all-products" data-category-id="all">
                                <i class="fas fa-th-large me-2"></i> All Products
                            </a>
                        </li>

                        <!-- Services (Main Categories) -->
                        {% for service in services %}
                            <li class="nav-item">
                                <a class="nav-link dropdown-toggle"
                                   data-bs-toggle="collapse"
                                   href="#service-{{ service.id }}"
                                   data-service-id="{{ service.id }}">
                                   <i class="fas fa-tag me-2"></i> {{ service.name }}
                                </a>

                                <div class="collapse" id="service-{{ service.id }}" data-bs-parent="#sidenavParent">
                                    <div class="row">
                                        <div class="col-12 py-2">
                                            <ul class="list-styled fs-base subcategory-list">
                                                {% for category in service_categories|get_item:service %}
                                                    <li class="list-styled-item">
                                                        <a class="list-styled-link category-link"
                                                           href="#"
                                                           data-category-id="{{ category.id }}">
                                                            {{ category.name }}
                                                            <span class="badge bg-light text-dark ms-2">{{ category.product_count }}</span>
                                                        </a>
                                                    </li>
                                                {% empty %}
                                                    <li class="list-styled-item">No categories available</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>

                    <!-- Price Filter -->
                    <div class="filter-section mt-4">
                        <h5 class="sidebar-heading">Price Range</h5>
                        <div class="price-slider-container px-2 py-3">
                            <div class="price-inputs d-flex justify-content-between mb-2">
                                <div class="price-input">
                                    <label for="min-price" class="form-label small">Min</label>
                                    <input type="number" id="min-price" class="form-control form-control-sm" value="0">
                                </div>
                                <div class="price-input">
                                    <label for="max-price" class="form-label small">Max</label>
                                    <input type="number" id="max-price" class="form-control form-control-sm" value="1000">
                                </div>
                            </div>
                            <button id="apply-price-filter" class="btn btn-sm btn-outline-primary w-100 mt-2">Apply Filter</button>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <!-- Category ends -->

        <div class="col-12 col-lg">
            <!-- Search bar and cart in one line with dropdown -->
            <nav class="navbar navbar-expand navbar-light pt-0 pt-lg-3">
                <div class="container-fluid d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center w-100">
                        <div class="dropdown me-1 me-md-2">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="d-none d-sm-inline">Categories</span>
                                <span class="d-inline d-sm-none"><i class="fas fa-list"></i></span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                                <li><a class="dropdown-item" href="#" onclick="filterProducts('all')">All Products</a></li>
                                {% for category in categories %}
                                <li><a class="dropdown-item" href="#" onclick="filterProducts('{{ category.id }}')">{{ category.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="navbar-form flex-grow-1 me-1 me-md-2" style="max-width: 550px;">
                            <div class="input-group">
                                <input id="search-input" class="form-control form-control-underline form-control-sm border-dark"
                                       type="search" name="search" placeholder="Search..."
                                       aria-label="Search" value="{{ search_query|default:'' }}" onkeyup="searchProducts(event)">
                            </div>
                            <div id="search-suggestions" class="position-absolute bg-white shadow-sm rounded-bottom d-none"
                                 style="width: calc(100% - 50px); z-index: 1000; max-height: 300px; overflow-y: auto;">
                            </div>
                        </div>
                        <div class="cart-button-count">
                            <a href="{% url 'cart' %}" class="btn btn-dark btn-sm cart-button-count">
                                <i class="fe fe-shopping-cart"></i> <span class="d-none d-sm-inline">Cart</span> <span id="cart-button-count">{{ cart_count }}</span>
                            </a>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- PRODUCT CARDS DISPLAY -->
            <section class="pb-12">
                <!-- Shop Header with Title and Description - Hidden on small screens -->
                <div class="shop-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <h1 class="display-6 mb-0 d-none d-md-block">Products</h1>
                            <div class="d-flex align-items-center">
                                <label for="sort-products" class="me-2 text-muted mb-0">Sort by:</label>
                                <select id="sort-products" class="form-select form-select-sm" style="width: auto;">
                                    <option value="newest">Newest</option>
                                    <option value="price-low">Price: Low to High</option>
                                    <option value="price-high">Price: High to Low</option>
                                    <option value="popular">Most Popular</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Featured Products Section -->
                <div class="featured-products-section mb-5">
                    <div class="section-header d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Featured Products</h2>
                        <div class="section-decoration"></div>
                    </div>
                    <div class="row">
                        {% for product in products %}
                            {% if product.featured %}
                                <div class="col-12 col-md-6 col-lg-4 mb-4">
                                    <div class="featured-product-card" data-product-id="{{ product.id }}">
                                        <div class="featured-product-image">
                                            <img src="{{ product.image.url }}" alt="{{ product.name }}" onerror="this.src='{% static 'img/placeholder.png' %}'">
                                            <div class="featured-badge">FEATURED</div>
                                        </div>
                                        <div class="featured-product-content">
                                            <h3 class="featured-product-title">{{ product.name }}</h3>
                                            <p class="featured-product-description">{{ product.description|truncatechars:100 }}</p>
                                            <div class="featured-product-price">${{ product.price }}</div>
                                            <div class="featured-product-buttons">
                                                <button class="btn-view-product" onclick="window.location.href='{% url 'product' product.id %}'">
                                                    View Details
                                                </button>
                                                <button class="btn-add-to-cart" onclick="addToCartWithAnimation({{ product.id }})">
                                                    <i class="fe fe-shopping-cart"></i> Add to Cart
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% if forloop.counter == 3 %}
                                    {% comment %} Stop after 3 items {% endcomment %}
                                {% elif forloop.counter > 3 %}
                                    {% comment %} Skip items after 3 {% endcomment %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Category Highlights -->
                <div class="category-highlights mb-5">
                    <div class="row">
                        {% for category in categories|slice:":3" %}
                            <div class="col-12 col-md-4 mb-4">
                                <button type="button" class="category-highlight-card" onclick="filterProducts('{{ category.id }}')" aria-label="Browse {{ category.name }}">
                                    <div class="category-highlight-content">
                                        <h3>{{ category.name }}</h3>
                                        <p>{{ category.product_count }} Products</p>
                                        <span class="category-link">Browse <i class="fe fe-arrow-right"></i></span>
                                    </div>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="products-section">
                    <div class="section-header d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">All Products</h2>
                        <div class="section-decoration"></div>
                    </div>
                    <div class="row" id="product-list">
                        {% for product in products %}
                            <div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-4">
                                {% include 'partials/nigerian-product-card.html' %}
                                {% include 'partials/modals/modal-product.html' %}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Empty State (when no products are found) -->
                {% if not products %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <img src="{% static 'img/empty-cart.svg' %}" alt="No products found" style="max-width: 150px;">
                    </div>
                    <h3>No products found</h3>
                    <p class="text-muted">Try adjusting your search or filter to find what you're looking for.</p>
                    <a href="{% url 'shop' %}" class="btn btn-primary mt-3">View All Products</a>
                </div>
                {% endif %}

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="text-center py-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Load More Button -->
                <div class="text-center mt-4 mb-5">
                    <button id="load-more-btn" class="btn btn-nigerian-secondary">
                        <i class="fas fa-sync-alt me-2"></i> Discover More Nigerian Products
                    </button>
                </div>
            </section>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/product-filter-handler.js' %}"></script>
<script>
    // Initialize unified card handler when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure all product cards have consistent styling
        if (typeof UnifiedCardHandler !== 'undefined') {
            UnifiedCardHandler.applyCardStyling();
        }

        // Override the appendProductsToDOM function to use unified styling
        if (typeof window.appendProductsToDOM === 'function') {
            const originalAppendFunction = window.appendProductsToDOM;

            window.appendProductsToDOM = function(products) {
                // Call the original function
                originalAppendFunction(products);

                // Apply unified styling to new cards
                setTimeout(() => {
                    if (typeof UnifiedCardHandler !== 'undefined') {
                        UnifiedCardHandler.applyCardStyling();
                    }
                }, 100);
            };
        }
    });
</script>

<!-- JavaScript to Handle Filter and Cart Actions -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add additional styles for active category
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            .category-link.active {
                font-weight: bold;
                color: #008751 !important;
                background-color: rgba(0, 135, 81, 0.1);
                border-radius: 4px;
            }
            .sidebar-heading {
                font-size: 1.1rem;
                font-weight: 600;
                color: #333;
                padding: 0.5rem 1rem;
                border-bottom: 1px solid #eee;
                margin-bottom: 0.5rem;
            }
            .subcategory-list {
                padding-left: 1.5rem;
            }
            .filter-section {
                border-top: 1px solid #eee;
                padding-top: 1rem;
            }

            /* Hide filter sidebar on small screens */
            @media (max-width: 991.98px) {
                .category-sidebar {
                    display: none !important;
                }
            }
        `;
        document.head.appendChild(styleElement);

        // Get all category links
        const categoryLinks = document.querySelectorAll('.category-link');
        const allProductsButton = document.getElementById('all-products');

        // Set active class for clicked category
        function setActiveCategory(element) {
            // Remove active class from all links
            categoryLinks.forEach(link => {
                link.classList.remove('active');
            });

            // Add active class to clicked link
            element.classList.add('active');
        }

        // Handle all products button click
        allProductsButton.addEventListener('click', function(e) {
            e.preventDefault();
            setActiveCategory(this);
            filterProducts('all');
        });

        // Handle category link clicks
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                setActiveCategory(this);
                const categoryId = this.getAttribute('data-category-id');
                filterProducts(categoryId);
            });
        });

        // Handle price filter
        document.getElementById('apply-price-filter').addEventListener('click', function() {
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || 1000;

            filterProductsByPrice(minPrice, maxPrice);
        });

        // Filter products by category
        function filterProducts(categoryId) {
            // Update current category ID for AJAX loading
            currentCategoryId = categoryId;

            // Reset pagination for new filter
            currentPage = 1;
            hasMoreProducts = true;

            // Show loading indicator
            $('#loading-indicator').removeClass('d-none');

            // Clear product list
            $('#product-list').empty();

            // Reset load more button
            $('#load-more-btn').text('Discover More Nigerian Products').removeClass('disabled').prop('disabled', false);

            // Update active category in sidebar
            $('.category-link').removeClass('active');
            $(`.category-link[data-category-id="${categoryId}"]`).addClass('active');

            // Scroll to products section
            $('html, body').animate({
                scrollTop: $('.products-section').offset().top - 100
            }, 500);

            // Load products for selected category
            $.ajax({
                url: "{% url 'load_more_products' %}",
                type: "GET",
                data: {
                    'page': 1,
                    'per_page': 12,
                    'category_id': categoryId === 'all' ? '' : categoryId
                },
                success: function(response) {
                    // Append products to the list
                    if (response.products.length > 0) {
                        appendProductsToDOM(response.products);
                    } else {
                        $('#product-list').html(`
                            <div class="col-12 text-center py-5">
                                <div class="mb-4">
                                    <img src="{% static 'img/empty-cart.svg' %}" alt="No products found" style="max-width: 150px;">
                                </div>
                                <h3>No products found</h3>
                                <p class="text-muted">Try adjusting your search or filter to find what you're looking for.</p>
                            </div>
                        `);
                    }

                    // Check if there are more products
                    hasMoreProducts = response.has_more;

                    // Update UI
                    if (!hasMoreProducts) {
                        $('#load-more-btn').text('No More Products').addClass('disabled');
                    }

                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                },
                error: function() {
                    console.error('Error loading products');
                    $('#loading-indicator').addClass('d-none');
                }
            });
        }

        // Filter products by price (client-side filtering)
        function filterProductsByPrice(minPrice, maxPrice) {
            const productCards = document.querySelectorAll('.product-card-nigerian');

            productCards.forEach(card => {
                const priceElement = card.querySelector('.price-current');
                if (!priceElement) return;

                const priceText = priceElement.textContent.trim();
                const price = parseFloat(priceText.replace('$', ''));

                const container = card.closest('[data-product-id]');
                if (!container) return;

                if (price >= minPrice && price <= maxPrice) {
                    container.style.display = '';
                } else {
                    container.style.display = 'none';
                }
            });
        }
    });

    // Unified function for quantity control (increase or decrease)
    function updateQuantity(productId, change) {
        const quantityInput = document.getElementById('quantity-' + productId);
        let quantity = parseInt(quantityInput.value, 10) || 1; // Default to 1 if input is invalid

        // Update the quantity with the provided change (positive or negative)
        quantity = Math.max(1, Math.min(10, quantity + change)); // Ensure quantity is between 1 and 10

        // Update the input value
        quantityInput.value = quantity;

        // Update button states if the function exists
        if (typeof updateButtonStates === 'function') {
            updateButtonStates(productId);
        }

        // Add animation effect
        quantityInput.classList.add('quantity-changed');
        setTimeout(() => {
            quantityInput.classList.remove('quantity-changed');
        }, 300);
    }
</script>

<script type="text/javascript">
    const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};

    // Variables for dynamic product loading
    let currentPage = 1;
    let isLoading = false;
    let hasMoreProducts = true;
    let currentCategoryId = '';

    // Ensure any global modal-based addToCartWithEmail is disabled on the shop page
    (function(){
        function directAddToCart(productId, quantity){
            try{
                const qty = Number(quantity) || 1;
                if (typeof addToCart === 'function') {
                    addToCart(productId, qty);
                    return;
                }
                if (typeof EnhancedCartFlow !== 'undefined' && typeof EnhancedCartFlow.addToCart === 'function') {
                    EnhancedCartFlow.addToCart(productId, qty);
                    return;
                }
                // Fallback to any previously saved original function if present
                if (typeof window.originalAddToCartWithEmail === 'function') {
                    window.originalAddToCartWithEmail(productId, qty);
                    return;
                }
                console.warn('No direct addToCart implementation found.');
            } catch (err) {
                console.error('directAddToCart error:', err);
            }
        }
        // Force the global function to the direct implementation
        window.addToCartWithEmail = directAddToCart;
    })();

    // Function to add product to cart with animation
    function addToCartWithAnimation(productId) {
        // First show visual feedback on the button
        const button = event.currentTarget;
        if (button) {
            // Add a visual feedback class
            button.classList.add('adding-to-cart');

            // Add a temporary "Adding..." text
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fe fe-shopping-cart"></i> Adding...';

            // Disable the button temporarily to prevent multiple clicks
            button.disabled = true;

            // After a short delay, restore the button and add to cart
            setTimeout(() => {
                // Use our enhanced cart flow
                if (typeof EnhancedCartFlow !== 'undefined') {
                    EnhancedCartFlow.addToCartWithAnimation(productId);
                } else {
                    // Fallback to original function
                    add_to_cart(productId);
                }

                // Restore button after animation
                setTimeout(() => {
                    button.classList.remove('adding-to-cart');
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 1000);
            }, 300);
        } else {
            // If button not found, just add to cart
            if (typeof EnhancedCartFlow !== 'undefined') {
                EnhancedCartFlow.addToCartWithAnimation(productId);
            } else {
                add_to_cart(productId);
            }
        }
    }


    // Function to highlight the cart icon
    function highlightCartIcon() {
      const cartIcon = document.querySelector('.navbar .fa-shopping-cart');
      if (!cartIcon) return;

      // Add highlight class
      cartIcon.classList.add('cart-highlight');

      // Remove highlight class after animation completes
      setTimeout(() => {
        cartIcon.classList.remove('cart-highlight');
      }, 1500);
    }

    // Function to add flying animation to cart
    function addToCartAnimation(product_id) {
        const productCard = document.querySelector(`[data-product-id="${product_id}"]`);
        if (!productCard) return;

        const cartIcon = document.querySelector('.navbar .fa-shopping-cart');
        if (!cartIcon) return;

        // Get product image position
        const imgElement = productCard.querySelector('.product-img');
        if (!imgElement) return;

        const imgRect = imgElement.getBoundingClientRect();
        const cartRect = cartIcon.getBoundingClientRect();

        // Create flying element
        const flyingImg = document.createElement('div');
        flyingImg.className = 'flying-cart-item';
        flyingImg.style.backgroundImage = `url(${imgElement.src})`;
        flyingImg.style.width = '50px';
        flyingImg.style.height = '50px';
        flyingImg.style.position = 'fixed';
        flyingImg.style.top = `${imgRect.top}px`;
        flyingImg.style.left = `${imgRect.left}px`;
        flyingImg.style.borderRadius = '50%';
        flyingImg.style.backgroundSize = 'cover';
        flyingImg.style.backgroundPosition = 'center';
        flyingImg.style.zIndex = '9999';
        flyingImg.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
        flyingImg.style.transition = 'all 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28)';

        // Add to body
        document.body.appendChild(flyingImg);

        // Animate
        setTimeout(() => {
            flyingImg.style.top = `${cartRect.top}px`;
            flyingImg.style.left = `${cartRect.left}px`;
            flyingImg.style.width = '20px';
            flyingImg.style.height = '20px';
            flyingImg.style.opacity = '0';

            // Shake cart icon
            cartIcon.style.animation = 'shake 0.5s ease-in-out';

            // Remove flying element after animation
            setTimeout(() => {
                document.body.removeChild(flyingImg);
                cartIcon.style.animation = '';
            }, 800);
        }, 10);
    }

    // Optimized search functionality with better performance
    let searchTimeout;
    let lastSearchQuery = '';
    let searchCache = {}; // Simple cache for search results

    function searchProducts(event) {
        // Clear previous timeout
        clearTimeout(searchTimeout);

        // If Enter key is pressed, search immediately
        if (event.key === 'Enter') {
            performSearch();
            return;
        }

        // Otherwise, set a timeout to search after typing stops (reduced from 500ms to 300ms)
        searchTimeout = setTimeout(performSearch, 300);
    }

    // Function to perform the actual search with optimizations
    function performSearch() {
        const searchQuery = $('#search-input').val().trim();

        // Don't search if query is too short or same as last search
        if (searchQuery.length < 2) {
            return;
        }

        if (searchQuery === lastSearchQuery) {
            return; // Avoid duplicate searches
        }

        lastSearchQuery = searchQuery;

        // Reset pagination
        currentPage = 1;
        hasMoreProducts = true;
        currentCategoryId = '';

        // Show loading indicator
        $('#loading-indicator').removeClass('d-none');

        // Add loading state to search input
        $('#search-input').addClass('searching');

        // Clear product list with animation
        $('#product-list').fadeOut(150, function() {
            $(this).empty();

            // Check cache first
            if (searchCache[searchQuery]) {
                handleSearchResults(searchCache[searchQuery]);
                return;
            }

            // Reset load more button
            $('#load-more-btn').text('Discover More Nigerian Products').removeClass('disabled').prop('disabled', false);

            // Load products matching search query
            $.ajax({
                url: "{% url 'load_more_products' %}",
                type: "GET",
                data: {
                    'page': 1,
                    'per_page': 12,
                    'search': searchQuery
                },
                success: function(response) {
                    // Cache the results
                    searchCache[searchQuery] = response;

                    // Handle the results
                    handleSearchResults(response);
                },
                error: function() {
                    console.error('Error searching products');
                    $('#loading-indicator').addClass('d-none');
                    $('#search-input').removeClass('searching');
                    $('#product-list').fadeIn(150);
                }
            });
        });
    }

    // Separate function to handle search results (improves code organization)
    function handleSearchResults(response) {
        // Append products to the list
        if (response.products.length > 0) {
            appendProductsToDOM(response.products);
        } else {
            $('#product-list').html(`
                <div class="col-12 text-center py-5">
                    <div class="mb-4">
                        <img src="{% static 'img/empty-cart.svg' %}" alt="No products found" style="max-width: 150px;">
                    </div>
                    <h3>No products found</h3>
                    <p class="text-muted">Try adjusting your search to find what you're looking for.</p>
                </div>
            `);
        }

        // Check if there are more products
        hasMoreProducts = response.has_more;

        // Update UI
        if (!hasMoreProducts) {
            $('#load-more-btn').text('No More Products').addClass('disabled');
        }

        // Hide loading indicator and show results with animation
        $('#loading-indicator').addClass('d-none');
        $('#search-input').removeClass('searching');
        $('#product-list').fadeIn(200);
    }

    // Function to load more products
    function loadMoreProducts() {
        if (isLoading || !hasMoreProducts) return;

        isLoading = true;
        $('#loading-indicator').removeClass('d-none');
        $('#load-more-btn').prop('disabled', true);

        $.ajax({
            url: "{% url 'load_more_products' %}",
            type: "GET",
            data: {
                'page': currentPage + 1,
                'per_page': 12,
                'category_id': currentCategoryId === 'all' ? '' : currentCategoryId,
                'search': $('#search-input').val() || ''
            },
            success: function(response) {
                // Increment page number
                currentPage = response.current_page;

                // Check if there are more products
                hasMoreProducts = response.has_more;

                // Append products to the list
                if (response.products.length > 0) {
                    appendProductsToDOM(response.products);

                    // Apply price filter if active
                    const minPrice = parseFloat($('#min-price').val()) || 0;
                    const maxPrice = parseFloat($('#max-price').val()) || 1000;
                    if (minPrice > 0 || maxPrice < 1000) {
                        filterProductsByPrice(minPrice, maxPrice);
                    }
                }

                // Update UI
                if (!hasMoreProducts) {
                    $('#load-more-btn').text('No More Products').addClass('disabled');
                }

                isLoading = false;
                $('#loading-indicator').addClass('d-none');
                $('#load-more-btn').prop('disabled', false);
            },
            error: function() {
                console.error('Error loading more products');
                isLoading = false;
                $('#loading-indicator').addClass('d-none');
                $('#load-more-btn').prop('disabled', false);
            }
        });
    }

    // Function to append products to DOM
    function appendProductsToDOM(products) {
        const productList = document.getElementById('product-list');

        products.forEach(product => {
            // Create product card
            const productCard = document.createElement('div');
            productCard.className = 'col-12 col-md-6 col-lg-4 col-xl-3 mb-4';
            productCard.setAttribute('data-product-id', product.id);
            productCard.setAttribute('data-category-id', product.category_id);

            // Set product card HTML
            productCard.innerHTML = `
                <div class="product-card-nigerian">
                    <div class="product-img-container">
                        ${product.is_on_sale ? '<div class="product-badge-nigerian">Sale</div>' : ''}
                        ${product.is_new ? '<div class="product-badge-nigerian product-badge-new-nigerian">New</div>' : ''}



                        <img data-src="${product.image_url}" src="{% static 'img/placeholder.png' %}" alt="${product.name}" class="product-img lazyload" loading="lazy">
                        <div class="product-actions">
                            <button class="action-btn" data-bs-toggle="modal" data-bs-target="#modalProduct${product.id}" title="Quick View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn" onclick="add_to_cart(${product.id})" title="Add to Cart">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            <button class="action-btn" title="Add to Wishlist">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    </div>
                    <div class="product-info">
                        <div class="product-category">
                            <span class="category-badge-nigerian">${product.category}</span>
                        </div>
                        <h3 class="product-title">
                            <a href="${product.url}">${product.name}</a>
                        </h3>

                        <!-- Cultural Significance (Short) -->
                        <div class="cultural-significance-short">
                            Authentic Nigerian product
                        </div>

                        <div class="product-price">
                            ${product.is_on_sale && product.regular_price ?
                                `<span class="price-old">$${product.regular_price}</span>
                                <span class="price-current">$${product.price}</span>` :
                                `<span class="price-current">$${product.price}</span>`
                            }
                        </div>
                        <button class="btn-add-to-cart-nigerian" onclick="add_to_cart(${product.id})">
                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        </button>
                    </div>
                </div>


            `;

            // Append to product list
            productList.appendChild(productCard);

            // Create modal for product
            createProductModal(product);
        });

        // Initialize lazy loading for new images
        initLazyLoading();
    }

    // Function to create product modal
    function createProductModal(product) {
        // Create modal element
        const modalElement = document.createElement('div');
        modalElement.className = 'modal fade';
        modalElement.id = `modalProduct${product.id}`;
        modalElement.tabIndex = '-1';
        modalElement.role = 'dialog';
        modalElement.setAttribute('aria-hidden', 'true');

        // Set modal HTML
        modalElement.innerHTML = `
            <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                <div class="modal-content">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; top: 15px; right: 15px;">
                        <i class="fe fe-x"></i>
                    </button>
                    <div class="container-fluid px-xl-0">
                        <div class="row align-items-center mx-xl-0">
                            <div class="col-12 col-lg-6 col-xl-5 py-4 py-xl-0">
                                <img src="${product.image_url}" class="img-fluid rounded" alt="${product.name}" style="border-radius: 10px;">
                            </div>
                            <div class="col-12 col-lg-6 col-xl-7 py-4 py-xl-0">
                                <h4 class="mb-3" style="font-weight: 600; font-size: 1.5rem; color: #343a40;">${product.name}</h4>
                                <div class="mb-3">
                                    <span class="h5" style="color: #28a745;">$${product.price}</span>
                                </div>
                                <p class="mb-4" style="color: #6c757d;">${product.description || 'No description available'}</p>
                                <div class="quantity-control d-flex align-items-center mb-3" style="gap: 10px;">
                                    <button class="btn btn-outline-secondary quantity-button" onclick="updateQuantity(${product.id}, -1)" style="width: 40px; height: 40px; border-radius: 8px;">-</button>
                                    <input type="number" class="form-control text-center" value="1" min="1" max="10" id="quantity-${product.id}" style="width: 60px; border-radius: 8px; font-size: 1rem; padding: 5px;">
                                    <button class="btn btn-outline-secondary quantity-button" onclick="updateQuantity(${product.id}, 1)" style="width: 40px; height: 40px; border-radius: 8px;">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart-button" onclick="add_to_cart(${product.id})">Add to Cart</button>
                                <a class="btn btn-link w-100 mt-3" href="${product.url}" style="color: #007bff;">
                                    More Product Info <i class="fe fe-info ms-2"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Append to body
        document.body.appendChild(modalElement);
    }

    // Initialize lazy loading for images with improved performance
    function initLazyLoading() {
        const lazyImages = document.querySelectorAll('img.lazyload');

        if ('IntersectionObserver' in window) {
            // Use a single observer for all images with optimized options
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                          // Create a new image to preload
                          const tempImg = new Image();
                          tempImg.onload = function() {
                            // Once preloaded, update the visible image
                            img.src = img.dataset.src;
                            img.classList.add('loaded');
                            img.classList.remove('lazyload');
                            // Remove the data-src to prevent potential reloading
                            img.removeAttribute('data-src');
                          };
                          tempImg.src = img.dataset.src;
                        }
                        // Stop observing this image
                        observer.unobserve(img);
                    }
                });
            }, {
                // Optimize observer options
                rootMargin: '50px 0px', // Start loading when image is 50px from viewport
                threshold: 0.1 // Trigger when at least 10% of the image is visible
            });

            // Observe all lazy images
            lazyImages.forEach(img => {
                imageObserver.observe(img);
            });
        } else {
            // Fallback for browsers that don't support IntersectionObserver
            // Load images with a slight delay to prevent blocking the main thread
            setTimeout(() => {
                lazyImages.forEach(img => {
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.add('loaded');
                        img.classList.remove('lazyload');
                    }
                });
            }, 100);
        }
    }

    // Optimized function to create product modal (used by the optimized product rendering)
    function createProductModalOptimized(product) {
        // Create modal element
        const modalElement = document.createElement('div');
        modalElement.className = 'modal fade';
        modalElement.id = `modalProduct${product.id}`;
        modalElement.tabIndex = '-1';
        modalElement.role = 'dialog';
        modalElement.setAttribute('aria-hidden', 'true');

        // Set modal HTML with lazy loading for the image
        modalElement.innerHTML = `
            <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                <div class="modal-content">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; top: 15px; right: 15px;">
                        <i class="fe fe-x"></i>
                    </button>
                    <div class="container-fluid px-xl-0">
                        <div class="row align-items-center mx-xl-0">
                            <div class="col-12 col-lg-6 col-xl-5 py-4 py-xl-0">
                                <img data-src="${product.image_url}" src="{% static 'img/placeholder.png' %}" class="img-fluid rounded lazyload" alt="${product.name}" style="border-radius: 10px;" loading="lazy">
                            </div>
                            <div class="col-12 col-lg-6 col-xl-7 py-4 py-xl-0">
                                <h4 class="mb-3" style="font-weight: 600; font-size: 1.5rem; color: #343a40;">${product.name}</h4>
                                <div class="mb-3">
                                    <span class="h5" style="color: #28a745;">$${product.price}</span>
                                </div>
                                <p class="mb-4" style="color: #6c757d;">${product.description || 'No description available'}</p>
                                <div class="quantity-control d-flex align-items-center mb-3" style="gap: 10px;">
                                    <button class="btn btn-outline-secondary quantity-button" onclick="updateQuantity(${product.id}, -1)" style="width: 40px; height: 40px; border-radius: 8px;">-</button>
                                    <input type="number" class="form-control text-center" value="1" min="1" max="10" id="quantity-${product.id}" style="width: 60px; border-radius: 8px; font-size: 1rem; padding: 5px;">
                                    <button class="btn btn-outline-secondary quantity-button" onclick="updateQuantity(${product.id}, 1)" style="width: 40px; height: 40px; border-radius: 8px;">+</button>
                                </div>
                                <button class="btn btn-sm btn-primary add-to-cart-button" onclick="add_to_cart(${product.id})">Add to Cart</button>
                                <a class="btn btn-link w-100 mt-3" href="${product.url}" style="color: #007bff;">
                                    More Product Info <i class="fe fe-info ms-2"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Return the element instead of appending to body
        return modalElement;
    }

    // Optimized function to append products to DOM with better performance
    function appendProductsToDOM(products) {
        const productList = document.getElementById('product-list');

        // Use document fragment for better performance (reduces reflows)
        const fragment = document.createDocumentFragment();

        // Create all modals in a single batch
        const modalFragment = document.createDocumentFragment();

        // Process products in batches for smoother rendering
        const batchSize = 4;
        const batches = Math.ceil(products.length / batchSize);

        function processBatch(batchIndex) {
            if (batchIndex >= batches) {
                // All batches processed, append to DOM and initialize
                productList.appendChild(fragment);
                document.body.appendChild(modalFragment);
                initLazyLoading();
                return;
            }

            const start = batchIndex * batchSize;
            const end = Math.min(start + batchSize, products.length);

            for (let i = start; i < end; i++) {
                const product = products[i];

                // Create product card
                const productCard = document.createElement('div');
                productCard.className = 'col-12 col-md-6 col-lg-4 col-xl-3 mb-4';
                productCard.setAttribute('data-product-id', product.id);
                productCard.setAttribute('data-category-id', product.category_id);

                // Optimize HTML generation
                const saleTag = product.is_on_sale ? '<div class="product-badge-nigerian">Sale</div>' : '';
                const newTag = product.is_new ? '<div class="product-badge-nigerian product-badge-new-nigerian">New</div>' : '';
                const priceDisplay = product.is_on_sale && product.regular_price
                    ? `<span class="price-old">$${product.regular_price}</span><span class="price-current">$${product.price}</span>`
                    : `<span class="price-current">$${product.price}</span>`;

                // Set product card HTML with optimized template
                productCard.innerHTML = `
                    <div class="product-card-nigerian">
                        <div class="product-img-container">
                            ${saleTag}
                            ${newTag}
                            <img data-src="${product.image_url}" src="{% static 'img/placeholder.png' %}" alt="${product.name}" class="product-img lazyload" loading="lazy">
                            <div class="product-actions">
                                <button class="action-btn" data-bs-toggle="modal" data-bs-target="#modalProduct${product.id}" title="Quick View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="add_to_cart(${product.id})" title="Add to Cart">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                                <button class="action-btn" title="Add to Wishlist">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-info">
                            <div class="product-category">
                                <span class="category-badge-nigerian">${product.category}</span>
                            </div>
                            <h3 class="product-title">
                                <a href="${product.url}">${product.name}</a>
                            </h3>
                            <div class="cultural-significance-short">
                                Authentic Nigerian product
                            </div>
                            <div class="product-price">
                                ${priceDisplay}
                            </div>
                            <button class="btn-add-to-cart-nigerian" onclick="add_to_cart(${product.id})">
                                <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                            </button>
                        </div>
                    </div>
                `;

                // Add to fragment instead of directly to DOM
                fragment.appendChild(productCard);

                // Create modal for product and add to modal fragment
                const modalElement = createProductModalOptimized(product);
                modalFragment.appendChild(modalElement);
            }

            // Process next batch with a small delay to keep UI responsive
            setTimeout(() => processBatch(batchIndex + 1), 10);
        }

        // Start processing batches
        processBatch(0);
    }

    // Add shake animation keyframes
    const shakeStyle = document.createElement('style');
    shakeStyle.textContent = `
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-10deg); }
            100% { transform: rotate(0deg); }
        }
    `;
    document.head.appendChild(shakeStyle);

    // Document ready
    $(document).ready(function() {
        // Initialize lazy loading
        initLazyLoading();

        // Load more button click event
        $('#load-more-btn').on('click', function() {
            loadMoreProducts();
        });

        // Search functionality
        const searchInput = $('#search-input');
        const searchButton = $('#search-button');
        const searchSuggestions = $('#search-suggestions');

        // Debounce function to limit API calls during typing
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Function to get search suggestions
        const getSuggestions = debounce(function(query) {
            if (query.length < 2) {
                searchSuggestions.addClass('d-none').empty();
                return;
            }

            $.ajax({
                url: "{% url 'load_more_products' %}",
                type: "GET",
                data: {
                    'page': 1,
                    'per_page': 5,
                    'search': query
                },
                success: function(response) {
                    if (response.products.length > 0) {
                        searchSuggestions.empty().removeClass('d-none');

                        response.products.forEach(product => {
                            const suggestion = $(`
                                <div class="suggestion-item p-2 border-bottom d-flex align-items-center">
                                    <img src="${product.image_url}" alt="${product.name}" class="suggestion-img me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                    <div>
                                        <div class="suggestion-name">${product.name}</div>
                                        <div class="suggestion-price text-success">$${product.price}</div>
                                    </div>
                                </div>
                            `);

                            suggestion.on('click', function() {
                                window.location.href = product.url;
                            });

                            searchSuggestions.append(suggestion);
                        });

                        // Add "See all results" link
                        searchSuggestions.append(`
                            <div class="p-2 text-center">
                                <a href="#" id="see-all-results" class="text-primary">See all results</a>
                            </div>
                        `);

                        // Handle "See all results" click
                        $('#see-all-results').on('click', function(e) {
                            e.preventDefault();
                            performSearch(query);
                            searchSuggestions.addClass('d-none');
                        });
                    } else {
                        searchSuggestions.addClass('d-none').empty();
                    }
                }
            });
        }, 300);

        // Handle search input
        searchInput.on('input', function() {
            const query = $(this).val().trim();
            getSuggestions(query);
        });

        // Handle search button click
        searchButton.on('click', function() {
            const query = searchInput.val().trim();
            if (query.length > 0) {
                performSearch(query);
                searchSuggestions.addClass('d-none');
            }
        });

        // Handle Enter key in search input
        searchInput.on('keypress', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                const query = $(this).val().trim();
                if (query.length > 0) {
                    performSearch(query);
                    searchSuggestions.addClass('d-none');
                }
            }
        });

        // Close suggestions when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.navbar-form').length) {
                searchSuggestions.addClass('d-none');
            }
        });

        // Function to perform search
        function performSearch(query) {
            // Update current category ID for AJAX loading
            currentCategoryId = 'all';

            // Reset pagination for new search
            currentPage = 1;
            hasMoreProducts = true;

            // Show loading indicator
            $('#loading-indicator').removeClass('d-none');

            // Clear product list
            $('#product-list').empty();

            // Reset load more button
            $('#load-more-btn').text('Discover More Nigerian Products').removeClass('disabled').prop('disabled', false);

            // Load products for search query
            $.ajax({
                url: "{% url 'load_more_products' %}",
                type: "GET",
                data: {
                    'page': 1,
                    'per_page': 12,
                    'search': query
                },
                success: function(response) {
                    // Append products to the list
                    if (response.products.length > 0) {
                        appendProductsToDOM(response.products);
                    } else {
                        $('#product-list').html(`
                            <div class="col-12 text-center py-5">
                                <div class="mb-4">
                                    <img src="{% static 'img/empty-cart.svg' %}" alt="No products found" style="max-width: 150px;">
                                </div>
                                <h3>No products found</h3>
                                <p class="text-muted">No products match your search criteria. Try different keywords.</p>
                            </div>
                        `);
                    }

                    // Check if there are more products
                    hasMoreProducts = response.has_more;

                    // Update UI
                    if (!hasMoreProducts) {
                        $('#load-more-btn').text('No More Products').addClass('disabled');
                    }

                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                },
                error: function() {
                    console.error('Error loading products');
                    $('#loading-indicator').addClass('d-none');
                }
            });
        }

        // Optimized infinite scroll with throttling
        let scrollTimeout;
        let lastScrollTime = 0;
        const scrollThrottle = 100; // Throttle to once every 100ms

        $(window).on('scroll', function() {
            const now = Date.now();

            // Throttle scroll events
            if (now - lastScrollTime < scrollThrottle) {
                // If we're throttling, set a timeout to check after the throttle period
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(checkScrollPosition, scrollThrottle);
                return;
            }

            lastScrollTime = now;
            checkScrollPosition();
        });

        // Separate function to check scroll position
        function checkScrollPosition() {
            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                const windowHeight = $(window).height();
                const scrollTop = $(window).scrollTop();
                const docHeight = $(document).height();

                // Load more when user is 300px from bottom
                if (scrollTop + windowHeight > docHeight - 300) {
                    loadMoreProducts();
                }
            });
        }
    });

    // Force direct add-to-cart behavior after all scripts load to prevent modal popups
    <script>
window.addEventListener('load', function() {
    function directAddToCart(productId, quantity){
        try{
            const qty = Number(quantity) || 1;
            if (typeof addToCart === 'function') {
                addToCart(productId, qty);
                return;
            }
            if (typeof EnhancedCartFlow !== 'undefined' && typeof EnhancedCartFlow.addToCart === 'function') {
                EnhancedCartFlow.addToCart(productId, qty);
                return;
            }
            if (typeof window.originalAddToCartWithEmail === 'function') {
                window.originalAddToCartWithEmail(productId, qty);
                return;
            }
            console.warn('No addToCart implementation found when forcing directAddToCart.');
        } catch (err) {
            console.error('directAddToCart error:', err);
        }
    }

    // Reassign global functions to direct implementation
    window.addToCartWithEmail = directAddToCart;
    window.add_to_cart = function(product_id){ directAddToCart(product_id, 1); };
});
</script>

<script>
window.addEventListener('load', function() {
    // No-op safeguard for email collection modal removal already present
    // Direct wishlist handler that posts to the server and shows a toast
    function directAddToWishlist(productId) {
        try {
            const csrftokenEl = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrftoken = csrftokenEl ? csrftokenEl.value : null;
            if (!productId) return;
            $.ajax({
                url: '/add_to_wishlist/',
                type: 'POST',
                data: {
                    'product_id': productId,
                    'csrfmiddlewaretoken': csrftoken
                },
                success: function(res) {
                    if (res && res.success) {
                        // Update wishlist UI if needed
                        try { if (typeof updateWishlistCount === 'function') updateWishlistCount(res.wishlist_count); } catch(e){}
                        // Show inline toast
                        if (typeof Toastify === 'function') {
                            Toastify({ text: res.message || 'Added to wishlist', duration: 3000, close: true, gravity: 'top', position: 'right', backgroundColor: '#28a745' }).showToast();
                        } else {
                            console.info(res.message || 'Added to wishlist');
                        }
                    } else {
                        if (res && res.message) alert(res.message); else alert('Failed to add to wishlist');
                    }
                },
                error: function(err) {
                    console.error('Wishlist error', err);
                    alert('Failed to add to wishlist.');
                }
            });
        } catch (e) { console.error(e); }
    }

    // Force global overrides
    window.addToWishlistWithEmail = directAddToWishlist;
    window.add_to_wishlist = function(productId){ directAddToWishlist(productId); };
});
</script>
</body>
{% endblock %}
